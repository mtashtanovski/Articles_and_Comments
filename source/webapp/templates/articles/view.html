{% extends 'base.html' %}

{% block title %}Article {{ article.pk }}{% endblock %}
{% block nav %}
    {% if perms.webapp.change_article %}
        <li class="nav-item">
            <a class="nav-link" href="{% url "webapp:article_update_view" article.pk %}">Редактировать</a>
        </li>
    {% endif %}

    {% if perms.webapp.delete_article %}
        <li class="nav-item">
            <a class="nav-link" href="{% url "webapp:article_delete_view" article.pk %}">Удалить</a>
        </li>
    {% endif %}

    {% if perms.webapp.add_article %}
        <li class="nav-item">
            <a class="nav-link" href="{% url "webapp:article_comment_create" article.pk %}">Добавить коммент</a>
        </li>
    {% endif %}
{% endblock %}

{% block content %}
    <h1>{{ article.author }}</h1>
    <h3>{{ article.title }}</h3>
    <p>{{ article.content }}</p>
    <hr>
    {% if user.is_authenticated %}
        <div class="pr-2">
          <span class="" id="like_count">Likes - {{article.like_count}}</span>
          <button class="btn btn-link text-dark p-0 border-0 btn-outline-light" id="like-button" value="{{article.pk}}">
            <svg width="1.5em" height="1.5em" viewBox="0 0 16 16" class="bi bi-heart" fill="currentColor"
              xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd"
                d="M8 2.748l-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z" />
            </svg>
          </button>
        </div>

    {% else %}
        <div class="pr-2">
          <span class="" id="like_count"> Likes - {{article.like_count}}</span>
          <a href="{% url 'accounts:login' %}">
              Login to like
          </a>
        </div>
    {% endif %}
    <hr>
    <h3>Комментарии</h3>
    {% for comment in comments %}
        <span>{{ forloop.counter }}</span>
        <p>{{ comment.author }}</p>
        <p>{{ comment.content }}</p>
        {% if user.is_authenticated %}
        <div class="pr-2">
          <span class="" id="comment_like_count">Likes - {{comment.comment_like_count}}</span>
          <button class="btn btn-link text-dark p-0 border-0 btn-outline-light" id="comment-like-button" value="{{comment.pk}}">
            <i class="icon-social fas fa-heart fa-2x"></i>
          </button>
        </div>
        {% else %}
            <div class="pr-2">
              <span class="" id="comment_like_count"> Likes - {{comment.comment_like_count}}</span>
              <a href="{% url 'accounts:login' %}">
                  Login to like
              </a>
            </div>
        {% endif %}
        <hr>
        {% if perms.webapp.change_comment or user == commnet.author %}
            <p><a href="{% url "webapp:comment_update_view" comment.pk %}">Изменить</a></p>
        {% endif %}

        {% if perms.webapp.delete_comment or user == commnet.author %}
            <p><a href="{% url "webapp:comment_delete_view" comment.pk %}">Удалить</a></p>
        {% endif %}
        <hr style="border: dashed">
    {% endfor %}



    <h3>Теги</h3>
    {% for tag in article.tags.all %}
        {{ tag.name }}{% if not forloop.last %}, {% else %}. {% endif %}
    {% endfor %}

    <script type="text/javascript">
      $(document).on('click', '#like-button', function (e) {
        e.preventDefault();
        $.ajax({
          type: 'POST',
          url: '{% url "accounts:like" %}',
          data: {
            articlepk: $('#like-button').val(),
            csrfmiddlewaretoken: '{{ csrf_token }}',
            action: 'post'
          },
          success: function (json) {
            document.getElementById("like_count").innerHTML = "<span>Likes - </span>" ;
            document.getElementById("like_count").innerHTML += json['result']
            console.log(json)
          },
          error: function (xhr, errmsg, err) {

          }
        });
      })

      $(document).on('click', '#comment_like-button', function (e) {
        e.preventDefault();
        $.ajax({
          type: 'POST',
          url: '{% url "accounts:comment-like" %}',
          data: {
            commentpk: $('#comment-like-button').val(),
            csrfmiddlewaretoken: '{{ csrf_token }}',
            action: 'post'
          },
          success: function (json) {
            document.getElementById("comment_like_count").innerHTML = "<span>Likes - </span>" ;
            document.getElementById("comment_like_count").innerHTML += json['result']
            console.log(json)
          },
          error: function (xhr, errmsg, err) {

          }
        });
      })

    </script>
{% endblock %}
